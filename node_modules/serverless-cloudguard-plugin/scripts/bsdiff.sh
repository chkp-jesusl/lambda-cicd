#!/bin/bash

WORK_DIR=$1
ACTION=$2
BIN_PATH=$3

[[ "$BIN_PATH" == "" ]] && BSDIFF=`which bsdiff` || BSDIFF="$BIN_PATH/bsdiff"
[[ "$BIN_PATH" == "" ]] && BSPATCH=`which bspatch` || BSPATCH="$BIN_PATH/bspatch"

[[ $__PROTEGO_DEBUG != "" ]] &&  echo "BSDIFF=${BSDIFF}" || true;
[[ $__PROTEGO_DEBUG != "" ]] &&  echo "BSPATCH=${BSPATCH}" || true;

PATCH_EXT=".patch"
PROTECTED_FOLDER="${WORK_DIR}/protected"
EXTRACTED_LAMBDA_FOLDER="${WORK_DIR}/extracted"
ORIGINAL_FOLDER="${WORK_DIR}/original"
PATCH_FOLDER="${WORK_DIR}/patches"


function diff() {
    [[ ! -e  ${ORIGINAL_FOLDER} ]] && echo "${ORIGINAL_FOLDER} does not exist" && exit 1
    cd ${ORIGINAL_FOLDER}
    mkdir -p ${PATCH_FOLDER}
    for file in $(find . -type f | cut -sd / -f 2-)
    do
        protectedFilePath=${PROTECTED_FOLDER}/${file}
        patchFileName=${PATCH_FOLDER}/$(base64 <<< ${file})${PATCH_EXT}
        $BSDIFF ${protectedFilePath} ${file} ${patchFileName}
    done
}

function patch() {
    [[ ! -e  ${PATCH_FOLDER} ]] && echo "${PATCH_FOLDER} does not exist" && exit 1
    cd ${PATCH_FOLDER}
    mkdir -p ${PROTECTED_FOLDER}
    for file in $(find . -type f | cut -sd / -f 2-)
    do
        decodedFileName=$(base64 --decode <<< ${file%%.*})
        recoveredFilePath=${PROTECTED_FOLDER}/${decodedFileName}
        protectedFilePath=${EXTRACTED_LAMBDA_FOLDER}/${decodedFileName}
        DIR=$(dirname "${recoveredFilePath}")
        mkdir -p ${DIR}
        $BSPATCH ${protectedFilePath} ${recoveredFilePath} ${file}
    done
}

if [ "${ACTION}" = "diff" ]; then
    diff
else
    patch
fi